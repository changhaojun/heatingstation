<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<link rel="stylesheet" type="text/css" href="../webview/mapshow.css" />
	<style type="text/css">
		body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
	</style>
	<script src="/node_modules/react-native-webview-bridge/scripts/webviewbridge.js"></script>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=8gUFGe3pXx1AXmyOOp5O512AtAgRz7me"></script>
	<title>换热站地图</title>
</head>
<body>
<div class="mapShow">
	<div style="height: 30px; width: 100%; text-align: center; background-color: #f4f3ef">
		<select id="select"  onchange="getStationData(this.value)" style= "margin: 0;
			padding:0;
			padding-left: 10px;
			padding-top: -10px;
			border: none;
			margin-top: 5px;
			border-top: 1px solid #d38d06;
			border-left: 1px solid #d38d06;
			border-bottom: 1px solid #d38d06;
			border-right: 1px solid #d38d06;
			height: 25px;
			width: 50%;
			background: none;
			outline: none;
			appearance: none;
			 -ms-appearance: none;
			 -webkit-appearance: none;
			 -moz-appearance: none;
			background: url('../webview/img/select_arrow.png') no-repeat scroll right center transparent;"
			onchange="self.location.href=options[selectedIndex].value" >
		</select>
	</div>
	<div id="allmap"></div>
</div>
	<script type="text/javascript" src="../webview/jquery-1.11.3.min.js"></script>
</body>
</html>
<script type="text/javascript">
    $(document).ready(function(){
        getcompanyMessage();
    });
    //保存文本框的内容
    var iptValue;
    //用来保存区域的名字
    var globalurl="http://192.168.1.105";
    var accesstoken ="58ff546f055cd40f5c66a2b8";
    var flag;
    var res = [];
    var newRes = [];
    var latCoord = [];
    var branchRes = [];
    var stationRes = [];
    var switchValue = true ;
    var switchKey = true;

    //初始化地图
    var map = new BMap.Map("allmap", {});
    map.disableDoubleClickZoom(true);
    map.enableScrollWheelZoom();
    var styleJson = [
        {
            "featureType": "building",
            "elementType": "all",
            "stylers": {
                "hue": "#007fff",
            }
        },
        {
            "featureType": "road",
            "elementType": "all",
            "stylers": {
                "color": "#ffffff",
            }
        }
    ]
    map.setMapStyle({styleJson:styleJson});

    //set marker type 初始化marker类型
    function addMarker(i,point,index,flagX,text){
        var myIcon = new BMap.Icon("../webview/img/marker"+i+".png", new BMap.Size(49,50));
        var marker = new BMap.Marker(point, {icon: myIcon});
        if (flagX == 0){
            if(marker.addEventListener){
                marker.addEventListener("click",showChildcompany);
            }else if(marker.attachEvent){
                marker.attachEvent("onclick",showChildcompany);
            }
        }else if(flagX == 1){
            if(marker.addEventListener){
                marker.addEventListener("click",showArea);
            }else if(marker.attachEvent){
                marker.attachEvent("onclick",showArea);
            }
        }else{
            if(flagX == 2){
                if(marker.addEventListener){
                    marker.addEventListener("click",showState);
                }else if(marker.attachEvent){
                    marker.attachEvent("onclick",showState);
                }
            }
        }
        var label = new BMap.Label(text,{offset:new BMap.Size(8,16)});
        label.setStyle({
            color           :  "white",
            border          :  "none",
            backgroundColor :  "none",
            fontSize        :  "15px",
            lineHeight      :  "12px",
            textAlign       :  "center",
            width           :  "30px",
            height          :  "20px",
        })
        marker.setLabel(label);
        map.addOverlay(marker);
        marker.enableMassClear();
    }

    //显示名字的marker
    function showNamemarker(point,index,text,i,imgW,imgH){
        var opts = {
            position : point,
            offset   : new BMap.Size(-40, 30),
        }
        var label = new BMap.Label(text, opts);
        label.setStyle({
            color          :  "white",
            backgroundImage:  "url('../webview/img/squre"+i+".png')",
            fontSize       :  "13px",
            backgroundColor:  "none",
            width          :  imgW+"px",
            border         :  "none",
            height         :  imgH+"px",
            lineHeight     :  "20px",
            fontFamily     :  "微软雅黑",
            lineHeight     :  "26px",
            textAlign      :  "center",
        });

        map.addOverlay(label);
        label.enableMassClear();
    }

    //显示换热站的marker图标
    function showstationMarker(point,index,text){
        var opts = {
            position : point,
        }
        var label = new BMap.Label(text, opts);
        label.setStyle({
            width          :  "auto",
            height         :  "25px",
            backgroundColor:  "#e9757e",
            color          :  "white",
            fontSize       :  "13px",
            border         :  "none",
            borderRadius   :   "8px",
            fontFamily     :  "微软雅黑",
            lineHeight     :  "26px",
            textAlign      :  "center",
        });
        if(label.addEventListener){
            label.addEventListener("click",showMessage);
        }else if(label.attachEvent){
            label.attachEvent("onclick",showMessage);
        }
        map.addOverlay(label);
        label.enableMassClear();
    }

    //动态加载指标元素
    function createElement(flag){
        $.ajax({
            url:globalurl+"/v1_0_0/station_tag",
            type:"get",
            dataType:"JSON",
            data:{
                access_token:accesstoken,
            },
            success:function(data){
                console.info(data);
                if(flag == true){
                    $("#select").append("<option  value="+data.station_tag[5]._id+" >"+data.station_tag[5].tag_name+""+
                        "</option>"
                    );
                }else if(flag == false){
                    $("#select").append("<option value="+data.station_tag[0]._id+" >"+data.station_tag[0].tag_name+""+
                        "</option>"
                    );
                    for( var x= 1; x <data.station_tag.length; x++){
                        $("#select").append("<option value="+data.station_tag[x]._id+" >"+data.station_tag[x].tag_name+""+
                            "</option>"
                        );
                    }
                }

            }
        })
    }

    //获取地图的中心坐标及显示级别
    //1.根据后台返回数据计算两点之间的中心点
    function setZoom(points){
        if(points.length>0){
            var maxLng = points[0].lng;
            var minLng = points[0].lng;
            var maxLat = points[0].lat;
            var minLat = points[0].lat;
            var res;
            for (var i = points.length - 1; i >= 0; i--) {
                res = points[i];
                if(res.lng > maxLng) maxLng =res.lng;
                if(res.lng < minLng) minLng =res.lng;
                if(res.lat > maxLat) maxLat =res.lat;
                if(res.lat < minLat) minLat =res.lat;
            };
            var cenLng =(parseFloat(maxLng)+parseFloat(minLng))/2;
            var cenLat = (parseFloat(maxLat)+parseFloat(minLat))/2;
            var zoom = getZoom(maxLng, minLng, maxLat, minLat);
            map.centerAndZoom(new BMap.Point(cenLng,cenLat), zoom);
        }else{
            //没有坐标，显示西安
            map.centerAndZoom(new BMap.Point(108.948024,34.263161), 12);
        }
    }

    //2.根据经纬极值计算地图显示级别
    function getZoom (maxLng, minLng, maxLat, minLat) {
        var zoom = ["50","100","200","500","1000","2000","5000","10000","20000","25000","50000","100000","200000","500000","1000000","2000000"]//级别18到3。
        var pointA = new BMap.Point(maxLng,maxLat);
        var pointB = new BMap.Point(minLng,minLat);
        var distance = map.getDistance(pointA,pointB).toFixed(1);
        for (var i = 0,zoomLen = zoom.length; i < zoomLen; i++) {
            if(zoom[i] - distance > 0){
                return 18-i+3;//之所以会多3，是因为地图范围常常是比例尺距离的10倍以上。所以级别会增加3。
            }
        };
    }

    //获取点击marker绑定的Id值
    function  findId(ev,showRes){
        var ev = ev || window.event;
        var p = ev.target || ev.srcElement;
        var markerPositionlat = p.getPosition().lat;
        var showId;
        if( markerPositionlat){
            for(var x = 0 ; x < showRes.length ; x++){
                if( showRes[x].value == markerPositionlat){
                    showId = showRes[x].name;
                }
            }
            return showId;
        }
    }

    //getdata from database 从后台数据库中获取总公司数据
    function  getcompanyMessage(){
        createElement(true);
        $.ajax({
            url:globalurl+"/v1_0_0/company",
            dataType:"JSON",
            type:"get",
            data:{
                access_token:accesstoken,
                tag_id:2,
            },
            success:function(data){
                console.info(data);
                //1.设置地图的中心及显示级别
                //1.设置地图的中心及显示级别
                var lat = parseFloat(data.company_data[0].location.split(",")[0]);
                var lng = parseFloat(data.company_data[0].location.split(",")[1]);
                map.centerAndZoom(new BMap.Point(lat,lng), 12);
                //2.格式化数据
                for(var i = 0; i < data.company_data.length; i++ ){
                    var Point = new BMap.Point( data.company_data[i].location.split(",")[0],data.company_data[i].location.split(",")[1]);
                    var energyShow = data.company_data[i].data_value;
                    var companyName = data.company_data[i].company_name;
                    latCoord.push( data.company_data[i].location.split(",")[1]);
                    addMarker(3,Point, i, 0,energyShow);
                    showNamemarker(Point,i,companyName,0,88,26);
                    res.push({
                        name  : data.company_data[i].company_id,
                        value : latCoord.pop(),
                    });
                }
            }
        });
    }


    //从后台数据库中获取分公司数据并进行格式化
    function  getChildcompanyData(companyId){
        $.ajax({
            url:globalurl+"/v1_0_0/company",
            dataType:"JSON",
            type:"get",
            data:{
                access_token:accesstoken ,
                tag_id:2,
                company_id:companyId,
            },
            success:function(data){
                console.info(data);
                //1.设置地图的中心及显示级别
                var pointsLocation = [];
                for(var i = 0; i< data.company_data.length ; i++){
                    if(data.company_data[i].location){
                        pointsLocation.push({
                            lat : data.company_data[i].location.split(",")[1],
                            lng : data.company_data[i].location.split(",")[0],
                        })
                    }
                }
                setZoom(pointsLocation);
                //2.格式化数据
                for(var i = 0; i < data.company_data.length; i++ ){
                    var linePoint = new BMap.Point( data.company_data[i].location.split(",")[0],data.company_data[i].location.split(",")[1]);
                    var energyShow = data.company_data[i].data_value;
                    var companyName = data.company_data[i].company_name;
                    latCoord.push( data.company_data[i].location.split(",")[1]);
                    addMarker(0,linePoint, i, 1,energyShow);
                    showNamemarker(linePoint,i,companyName,1,76,27);
                    newRes.push({
                        name  : data.company_data[i].company_id,
                        value : latCoord.pop(),
                    });
                }
            }
        });
    }

    //从后台数据库中获取具体的支线数据并进行格式化
    function getAreaData(companyId){
        $.ajax({
            url:globalurl+"/v1_0_0/companies/branch",
            dataType:"JSON",
            type:"get",
            data:{
                access_token:accesstoken ,
                tag_id:2,
                company_id:companyId,
            },
            success:function(data){
                console.info(data);
                //1.设置地图中心及显示级别
                var pointsLocation = [];
                for(var i = 0; i< data.branch_count.length ; i++){
                    if(data.branch_count[i].location){
                        pointsLocation.push({
                            lat :data.branch_count[i].location.split(",")[1],
                            lng :data.branch_count[i].location.split(",")[0],
                        })
                    }
                }
                setZoom(pointsLocation);
                //2.格式化数据
                for(var x = 0;x < data.branch_count.length; x++){
                    var branchPoint = new BMap.Point( data.branch_count[x].location.split(",")[0],data.branch_count[x].location.split(",")[1]);
                    var valueShow=data.branch_count[x].data_value;
                    var branchName=data.branch_count[x].branch_name;
                    latCoord.push( data.branch_count[x].location.split(",")[1]);
                    addMarker(1,branchPoint,x,2,valueShow);
                    showNamemarker(branchPoint ,x,branchName,3,75,27);
                    branchRes.push({
                        name  : data.branch_count[x].branch_id,
                        value : latCoord.pop(),
                    });
                }
                console.info(branchRes);
            }
        });
    }

    //从后台数据库中获取具体的换热站数据进行格式
    function getStationData(value){
        if(switchValue == true){
            $("#select").empty();
            createElement(false);
            switchValue = false;
        }
        $.ajax({
            url:globalurl+"/v1_0_0/station_data",
            dataType:"JSON",
            type:"get",
            data:{
                access_token:accesstoken,
                tag_id:value,
                branch_id:"58f0938616f12032500b6740",
            },
            success:function(data){
                //1.设置地图的中心点及显示级别
                var lat = parseFloat(data.station_count[0].location.split(",")[0]);
                var lng = parseFloat(data.station_count[0].location.split(",")[1]);
                map.centerAndZoom(new BMap.Point(lat,lng), 18);
                //2.格式化数据
                for(var x = 0;x < data.station_count.length; x++){
                    var statePoint = new BMap.Point( data.station_count[x].location.split(",")[0],data.station_count[x].location.split(",")[1]);
                    var valueShow = data.station_count[x].station_name+" "+data.station_count[x].data_value;
                    showstationMarker(statePoint,x,valueShow)
                    latCoord.push( data.station_count[x].location.split(",")[1]);
                    stationRes.push({
                        name  : data.station_count[x].station_name,
                        value : latCoord.pop(),
                    });
                }
            }
        });
    }

    //进入分公司区域
    function  showChildcompany(ev){
        //1.清除上一个级别的覆盖物并设置新的地图的尺寸，允许通过鼠标滚轮来进行地图的缩放
        map.clearOverlays();
        //2.find companyId (通过marker坐标来获得相应的id值)
        var companyId;
        companyId =  findId(ev,res);
        if(companyId){
            getChildcompanyData(companyId);
        }else{

        }
    }

    //进入支线区域
    function showArea(ev){
        //1.清除上一级别的覆盖物并设置新的地图尺寸，
        map.clearOverlays();
        //2.find AreaId (通过marker坐标来获得相应的id值)
        var companyId ;
        companyId = findId(ev,newRes);
        if(companyId){
            getAreaData(companyId);
        }else{
            alert("当前点击的下级公司没有支线数据!");
        }
    }

    //显示具体的换热站
    function  showState(ev){
        //1.清除上一级别的覆盖物并设置新的地图尺寸，
        map.clearOverlays();
        map.enableScrollWheelZoom();
        //2.find branchId (通过marker坐标来获得相应的id值)
        var branchId;
        branchId = findId(ev,branchRes);
        if(branchId){
            if(switchKey == true){
                getStationData(1);
                switchKey = false;
            }else if(switchKey == false){
                getStationData(value);
            }
        }else{
            alert("当前点击的分支没有换热站!");
        }
    }

    //从地图进入其他事件的函数(列表或者组态模板)
    function showMessage(ev){
        WebViewBridge.send("coupons");
    }
</script>
